<VirtualHost *:443>
    # General setup for the virtual host, inherited from global configuration
    DocumentRoot "/var/www/html/default"
    ServerName portal.demo.openconext.org:443

    # Use separate log files for the SSL virtual host; note that LogLevel
    # is not inherited from httpd.conf.
    ErrorLog logs/portal_ssl_error_log
    TransferLog logs/portal_ssl_access_log
    LogLevel warn

    SSLEngine             on
    SSLProtocol           -ALL +SSLv3 +TLSv1
    SSLCipherSuite        ALL:!aNULL:!ADH:!eNULL:!LOW:!EXP:!RC4-MD5:RC4+RSA:+HIGH:+MEDIU
    SSLCertificateFile    /etc/httpd/keys/star.demo.openconext.org.pem
    SSLCertificateKeyFile /etc/httpd/keys/star.demo.openconext.org.key
    SSLCACertificateFile  /etc/httpd/keys/star.demo.openconext.org_cabundle.pem

    RewriteEngine On
    RewriteRule ^/$ /coin/$1 [L,R=permanent]

    <Files ~ "\.(cgi|shtml|phtml|php3?)$">
        SSLOptions +StdEnvVars
    </Files>
    <Directory "/var/www/cgi-bin">
        SSLOptions +StdEnvVars
    </Directory>

    SetEnvIf User-Agent ".*MSIE.*" \
             nokeepalive ssl-unclean-shutdown \
             downgrade-1.0 force-response-1.0

    CustomLog logs/ssl_request_log \
              "%t %h %{SSL_PROTOCOL}x %{SSL_CIPHER}x \"%r\" %b"


    # Proxy requests through to Tomcat using AJP
    # However, do not proxy shibboleth requests through to Tomcat
    ProxyPass /Shibboleth.sso !
    ProxyPass / ajp://localhost:8009/

    # Portal location
    <Location /coin>
        AuthType shibboleth
        ShibRequireSession Off
        require shibboleth
        ShibUseHeaders On
    </Location>

    # Calendar locations
    <Location /calendar>
        AuthType shibboleth
        ShibRequireSession Off
        require shibboleth
        ShibUseHeaders On
    </Location>
    <Location /calendar/dav>
    </Location>

    # Messaging locations
    <Location /messaging>
        AuthType shibboleth
        ShibRequireSession Off
        require shibboleth
        ShibUseHeaders On
    </Location>
    <Location /messaging/rss>
    </Location>
    <Location /messaging/postprocessing>
    </Location>
</VirtualHost>

<VirtualHost *:80>
    # General setup for the virtual host, inherited from global configuration
    DocumentRoot "/var/www/html/default"
    ServerName portal.demo.openconext.org:80

    # Use separate log files for this virtual host; note that LogLevel
    # is not inherited from httpd.conf.
    ErrorLog logs/portal_error_log
    TransferLog logs/portal_access_log
    LogLevel warn

    # Proxy requests through to Tomcat using AJP
    ProxyPass /coin/gadgetdefinition ajp://localhost:8009/coin/gadgetdefinition

    # Portal location
    <Location /coin/gadgetdefinition>
        AuthType shibboleth
        ShibRequireSession Off
        require shibboleth
        ShibUseHeaders On
    </Location>
</VirtualHost>